# SPEC-EXCEL-TRANSFORM-001: Excel 데이터 로더 신규 MOLIT API 형식 지원

---

## 1. 프로젝트 개요

### 1.1 배경

현재 아파트 실거래가 분석 대시보드(`app.py`)는 국토교통부 실거래가 공개시스템에서 다운로드한 Excel 파일을 로드하여 분석합니다. 그러나 국토교통부는 2024년 7월 17일부터 신규 OpenAPI 형식을 배포하였으며, 이에 따라 Excel 파일의 컬럼 구조가 변경되었습니다.

### 1.2 목적

- 신규 MOLIT API 형식의 Excel 파일을 기존 대시보드에서 원활하게 사용할 수 있도록 데이터 변환 모듈 개발
- 기존 형식과 신규 형식 모두 자동 감지하여 호환성 유지
- 사용자 경험 저하 없이 투명한 데이터 변환 제공

### 1.3 범위

| 구분 | 내용 |
|------|------|
| 포함 | 데이터 변환 모듈 개발, 형식 자동 감지, 지역코드 매핑 |
| 제외 | API 직접 호출 기능, 새로운 컬럼 활용 UI, 데이터베이스 저장 |

---

## 2. 현황 분석

### 2.1 기존 vs 신규 컬럼 비교표

| 순번 | 기존 형식 (app.py 기대 컬럼) | 신규 API 형식 컬럼 | 신규 항목명(국문) | 변환 방법 |
|:----:|---------------------------|-------------------|-----------------|----------|
| 1 | NO | - | - | 행 인덱스로 자동 생성 |
| 2 | 시군구 | sggCd + umdNm | 지역코드 + 법정동 | 지역코드 조회 후 법정동 결합 |
| 3 | 단지명 | aptNm | 단지명 | 직접 매핑 |
| 4 | 전용면적(㎡) | excluUseAr | 전용면적 | 직접 매핑 + 단위 추가 |
| 5 | 계약년월 | dealYear + dealMonth | 계약년도 + 계약월 | YYYYMM 형식으로 결합 |
| 6 | 계약일 | dealDay | 계약일 | 직접 매핑 |
| 7 | 거래금액(만원) | dealAmount | 거래금액(만원) | 쉼표 제거 후 숫자 변환 |
| 8 | 층 | floor | 층 | 직접 매핑 |
| 9 | 건축년도 | buildYear | 건축년도 | 직접 매핑 |
| 10 | 해제사유발생일 | cdealDay | 해제사유발생일 | 직접 매핑 |

### 2.2 신규 API 추가 컬럼 (향후 활용 가능)

| 컬럼명(영문) | 항목명(국문) | 설명 | 활용 가능성 |
|-------------|------------|------|-----------|
| jibun | 지번 | 토지 지번 주소 | 상세 주소 표시 |
| cdealType | 해제여부 | 거래 취소 상태 | 취소 거래 필터링 개선 |
| dealingGbn | 거래유형 | 중개거래/직거래 구분 | 거래유형별 분석 |
| estateAgentSggNm | 중개사소재지 | 중개업소 위치 | 중개사 분석 |
| rgstDate | 등기일자 | 소유권 이전 등기일 | 등기 지연 분석 |
| aptDong | 아파트 동명 | 동 번호 | 동별 분석 |
| slerGbn | 매도자 | 개인/법인/공공기관/기타 | 매도자 유형 분석 |
| buyerGbn | 매수자 | 개인/법인/공공기관/기타 | 매수자 유형 분석 |
| landLeaseholdGbn | 토지임대부 아파트 여부 | Y/N | 특수 아파트 필터링 |

### 2.3 지역코드 매핑 테이블 (예시)

| 지역코드(sggCd) | 시군구명 |
|---------------|---------|
| 11110 | 서울특별시 종로구 |
| 11140 | 서울특별시 중구 |
| 11170 | 서울특별시 용산구 |
| 11200 | 서울특별시 성동구 |
| 11215 | 서울특별시 광진구 |
| 11230 | 서울특별시 동대문구 |
| 11260 | 서울특별시 중랑구 |
| 11290 | 서울특별시 성북구 |
| 11305 | 서울특별시 강북구 |
| 11320 | 서울특별시 도봉구 |
| 11350 | 서울특별시 노원구 |
| 11380 | 서울특별시 은평구 |
| 11410 | 서울특별시 서대문구 |
| 11440 | 서울특별시 마포구 |
| ... | ... |

> 참고: 전체 지역코드는 행정표준코드관리시스템(www.code.go.kr)의 법정동코드 10자리 중 앞 5자리 사용

---

## 3. 요구사항 정의 (EARS 형식)

### 3.1 유비쿼터스 요구사항 (Ubiquitous - 항상 적용)

| ID | 요구사항 | 검증 방법 |
|----|---------|----------|
| REQ-U-001 | 시스템은 **항상** Excel 파일 로드 시 데이터 무결성을 유지해야 한다 | 원본 데이터와 변환 데이터의 행 수 일치 검증 |
| REQ-U-002 | 시스템은 **항상** 거래금액을 정수형(만원 단위)으로 처리해야 한다 | 숫자 타입 검증 테스트 |
| REQ-U-003 | 시스템은 **항상** 변환 오류 발생 시 명확한 오류 메시지를 제공해야 한다 | 오류 메시지 가독성 검증 |

### 3.2 이벤트 기반 요구사항 (Event-Driven - WHEN...THEN)

| ID | 요구사항 | 검증 방법 |
|----|---------|----------|
| REQ-E-001 | **WHEN** 사용자가 Excel 파일을 업로드 **THEN** 시스템은 파일 형식(기존/신규)을 자동 감지한다 | 기존/신규 파일 각각 업로드하여 감지 확인 |
| REQ-E-002 | **WHEN** 신규 형식 파일이 감지됨 **THEN** 시스템은 자동으로 기존 형식으로 변환한다 | 신규 형식 파일 업로드 후 컬럼 구조 검증 |
| REQ-E-003 | **WHEN** 기존 형식 파일이 감지됨 **THEN** 시스템은 변환 없이 기존 로직을 적용한다 | 기존 파일 처리 시간 측정 |
| REQ-E-004 | **WHEN** 지역코드가 매핑 테이블에 없음 **THEN** 시스템은 지역코드를 그대로 표시하고 경고를 출력한다 | 존재하지 않는 지역코드 테스트 |

### 3.3 상태 기반 요구사항 (State-Driven - IF...THEN)

| ID | 요구사항 | 검증 방법 |
|----|---------|----------|
| REQ-S-001 | **IF** 파일에 'sggCd' 컬럼이 존재 **THEN** 신규 API 형식으로 판단한다 | 컬럼명 기반 감지 로직 테스트 |
| REQ-S-002 | **IF** 파일에 '시군구' 컬럼이 존재 **THEN** 기존 형식으로 판단한다 | 컬럼명 기반 감지 로직 테스트 |
| REQ-S-003 | **IF** dealAmount에 쉼표가 포함됨 **THEN** 쉼표를 제거 후 정수로 변환한다 | "12,000" → 12000 변환 검증 |
| REQ-S-004 | **IF** cdealDay 값이 비어있음 **THEN** 해제사유발생일을 빈 문자열로 설정한다 | 빈 값 처리 검증 |

### 3.4 금지 요구사항 (Unwanted - 하지 않아야 함)

| ID | 요구사항 | 검증 방법 |
|----|---------|----------|
| REQ-N-001 | 시스템은 원본 Excel 파일을 **수정하지 않아야** 한다 | 파일 해시값 비교 |
| REQ-N-002 | 시스템은 변환 중 데이터 **손실이 발생하지 않아야** 한다 | 변환 전후 행 수 및 필수 컬럼 값 비교 |
| REQ-N-003 | 시스템은 지원하지 않는 파일 형식에 대해 **처리를 시도하지 않아야** 한다 | 잘못된 형식 파일 업로드 시 오류 처리 확인 |

### 3.5 선택적 요구사항 (Optional - 가능하면)

| ID | 요구사항 | 검증 방법 |
|----|---------|----------|
| REQ-O-001 | **가능하면** 신규 API의 추가 컬럼(거래유형, 매도자, 매수자 등)을 보존하여 향후 활용 가능하게 한다 | 추가 컬럼 존재 여부 확인 |
| REQ-O-002 | **가능하면** 변환 결과를 캐시하여 동일 파일 재업로드 시 성능을 향상시킨다 | 동일 파일 재업로드 시간 측정 |

---

## 4. 기술 설계

### 4.1 아키텍처 개요

```
┌─────────────────────────────────────────────────────────────────┐
│                         app.py (메인)                            │
├─────────────────────────────────────────────────────────────────┤
│  load_data_from_upload()                                         │
│         │                                                        │
│         ▼                                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │            data_transformer.py (신규 모듈)               │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │  detect_format(df) → 'old' | 'new'              │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │                        │                                │    │
│  │            ┌───────────┴───────────┐                    │    │
│  │            ▼                       ▼                    │    │
│  │     기존 형식                  신규 형식                  │    │
│  │     (변환 없음)                    │                    │    │
│  │                                    ▼                    │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │  transform_to_legacy(df) → DataFrame            │    │    │
│  │  │    - generate_sigungu()                         │    │    │
│  │  │    - generate_contract_yearmonth()              │    │    │
│  │  │    - generate_row_number()                      │    │    │
│  │  │    - map_columns()                              │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │                        │                                │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │  region_code_mapper.py                          │    │    │
│  │  │    - REGION_CODE_MAP: dict                      │    │    │
│  │  │    - get_sigungu_name(code) → str               │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────┘    │
│         │                                                        │
│         ▼                                                        │
│  preprocess_data(df) → 기존 전처리 로직                          │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 모듈 구조

```
D:\ai_program\실거래가분석대시보드\
├── app.py                      # 메인 애플리케이션 (수정)
├── data_transformer.py         # 데이터 변환 모듈 (신규)
├── region_code_mapper.py       # 지역코드 매핑 모듈 (신규)
└── tests/                      # 테스트 디렉토리 (신규)
    ├── test_data_transformer.py
    └── test_region_code_mapper.py
```

### 4.3 핵심 함수 설계

#### 4.3.1 detect_format(df: DataFrame) -> str

```python
def detect_format(df: pd.DataFrame) -> str:
    """
    Excel 파일의 형식을 감지합니다.

    Args:
        df: 로드된 DataFrame

    Returns:
        'old': 기존 형식 (시군구, 단지명, 거래금액(만원) 등)
        'new': 신규 API 형식 (sggCd, aptNm, dealAmount 등)

    Raises:
        ValueError: 알 수 없는 형식인 경우
    """
```

#### 4.3.2 transform_to_legacy(df: DataFrame) -> DataFrame

```python
def transform_to_legacy(df: pd.DataFrame) -> pd.DataFrame:
    """
    신규 API 형식을 기존 형식으로 변환합니다.

    Args:
        df: 신규 형식 DataFrame

    Returns:
        기존 형식으로 변환된 DataFrame

    컬럼 매핑:
        - NO: 행 인덱스 (1부터 시작)
        - 시군구: sggCd 조회 + umdNm 결합
        - 단지명: aptNm
        - 전용면적(㎡): excluUseAr
        - 계약년월: dealYear + dealMonth (YYYYMM)
        - 계약일: dealDay
        - 거래금액(만원): dealAmount (쉼표 제거)
        - 층: floor
        - 건축년도: buildYear
        - 해제사유발생일: cdealDay
    """
```

#### 4.3.3 get_sigungu_name(code: str) -> str

```python
def get_sigungu_name(code: str) -> str:
    """
    지역코드를 시군구명으로 변환합니다.

    Args:
        code: 5자리 지역코드 (예: '11110')

    Returns:
        시군구명 (예: '서울특별시 종로구')
        매핑되지 않은 경우 코드 그대로 반환
    """
```

### 4.4 데이터 흐름

```
[Excel 업로드]
      │
      ▼
[pd.read_excel()]
      │
      ▼
[detect_format()] ─── 'old' ───▶ [preprocess_data()] ───▶ [대시보드]
      │
    'new'
      │
      ▼
[transform_to_legacy()]
      │
      ├── generate_no_column()
      ├── generate_sigungu()
      ├── generate_contract_yearmonth()
      ├── map_direct_columns()
      └── clean_deal_amount()
      │
      ▼
[preprocess_data()] ───▶ [대시보드]
```

### 4.5 예외 처리 전략

| 상황 | 처리 방법 |
|------|----------|
| 알 수 없는 파일 형식 | ValueError 발생, 사용자에게 지원 형식 안내 |
| 지역코드 매핑 실패 | 경고 로그 출력, 코드 값 그대로 사용 |
| 필수 컬럼 누락 | KeyError 발생, 누락 컬럼명 명시 |
| 데이터 타입 변환 실패 | 해당 셀 원본 값 유지, 경고 출력 |

---

## 5. 구현 단계

### 5.1 1단계: 지역코드 매핑 모듈 개발

**목표**: 지역코드를 시군구명으로 변환하는 기능 구현

**작업 내용**:
1. `region_code_mapper.py` 파일 생성
2. 서울시 전체 구 지역코드 매핑 테이블 정의
3. `get_sigungu_name()` 함수 구현
4. 단위 테스트 작성

**산출물**:
- `region_code_mapper.py`
- `tests/test_region_code_mapper.py`

### 5.2 2단계: 데이터 변환 모듈 개발

**목표**: 신규 형식을 기존 형식으로 변환하는 핵심 기능 구현

**작업 내용**:
1. `data_transformer.py` 파일 생성
2. `detect_format()` 함수 구현
3. `transform_to_legacy()` 함수 구현
4. 컬럼 매핑 및 데이터 정제 로직 구현
5. 단위 테스트 작성

**산출물**:
- `data_transformer.py`
- `tests/test_data_transformer.py`

### 5.3 3단계: app.py 통합

**목표**: 기존 애플리케이션에 변환 모듈 통합

**작업 내용**:
1. `data_transformer` 모듈 import
2. `load_data_from_upload()` 함수 수정
3. `load_data_from_path()` 함수 수정
4. 오류 처리 및 사용자 피드백 메시지 추가

**수정 파일**:
- `app.py`

### 5.4 4단계: 통합 테스트 및 검증

**목표**: 전체 시스템 동작 검증

**작업 내용**:
1. 기존 형식 파일로 정상 동작 확인
2. 신규 형식 파일로 정상 동작 확인
3. 다양한 엣지 케이스 테스트
4. 성능 테스트 (대용량 파일)

**검증 항목**:
- 기존 파일 호환성 100%
- 신규 파일 변환 정확도 100%
- 변환 시간 1초 미만 (10,000행 기준)

---

## 6. 테스트 계획

### 6.1 단위 테스트

| 테스트 ID | 테스트 대상 | 테스트 케이스 | 예상 결과 |
|----------|-----------|-------------|----------|
| UT-001 | detect_format | 기존 형식 DataFrame 입력 | 'old' 반환 |
| UT-002 | detect_format | 신규 형식 DataFrame 입력 | 'new' 반환 |
| UT-003 | detect_format | 알 수 없는 형식 입력 | ValueError 발생 |
| UT-004 | get_sigungu_name | '11380' 입력 | '서울특별시 은평구' 반환 |
| UT-005 | get_sigungu_name | 존재하지 않는 코드 입력 | 코드 그대로 반환 |
| UT-006 | transform_to_legacy | 신규 형식 DataFrame 입력 | 기존 형식 DataFrame 반환 |
| UT-007 | transform_to_legacy | dealAmount '12,000' | 12000 (정수) |
| UT-008 | transform_to_legacy | dealYear=2024, dealMonth=7 | 계약년월=202407 |

### 6.2 통합 테스트

| 테스트 ID | 테스트 시나리오 | 검증 항목 |
|----------|---------------|----------|
| IT-001 | 기존 형식 파일 업로드 | 모든 탭 정상 표시 |
| IT-002 | 신규 형식 파일 업로드 | 모든 탭 정상 표시 |
| IT-003 | 형식 혼합 파일 업로드 | 적절한 오류 메시지 |
| IT-004 | 빈 파일 업로드 | 적절한 오류 메시지 |
| IT-005 | 10,000행 파일 업로드 | 처리 시간 1초 미만 |

### 6.3 인수 테스트 (Given-When-Then)

#### AT-001: 신규 형식 파일 자동 변환

```gherkin
Given 사용자가 신규 MOLIT API 형식의 Excel 파일을 가지고 있다
  And 파일에는 sggCd, aptNm, dealAmount 등의 컬럼이 있다
When 사용자가 해당 파일을 대시보드에 업로드한다
Then 시스템은 자동으로 파일 형식을 감지한다
  And 신규 형식을 기존 형식으로 변환한다
  And 대시보드의 모든 차트와 테이블이 정상적으로 표시된다
```

#### AT-002: 기존 형식 파일 호환성 유지

```gherkin
Given 사용자가 기존 형식의 Excel 파일을 가지고 있다
  And 파일에는 시군구, 단지명, 거래금액(만원) 등의 컬럼이 있다
When 사용자가 해당 파일을 대시보드에 업로드한다
Then 시스템은 기존 로직을 그대로 적용한다
  And 대시보드의 동작에 변화가 없다
```

#### AT-003: 지역코드 변환

```gherkin
Given 신규 형식 파일에 sggCd='11380', umdNm='불광동' 데이터가 있다
When 시스템이 데이터를 변환한다
Then 시군구 컬럼에 '서울특별시 은평구 불광동'이 생성된다
```

---

## 7. 일정 (단계별)

### 7.1 마일스톤

| 단계 | 작업 내용 | 우선순위 | 의존성 |
|:----:|----------|:--------:|:------:|
| 1단계 | 지역코드 매핑 모듈 개발 | Primary (최우선) | 없음 |
| 2단계 | 데이터 변환 모듈 개발 | Primary (최우선) | 1단계 |
| 3단계 | app.py 통합 | Secondary (2순위) | 2단계 |
| 4단계 | 통합 테스트 및 검증 | Secondary (2순위) | 3단계 |
| 5단계 | 문서화 및 배포 | Optional (선택) | 4단계 |

### 7.2 작업 의존성 다이어그램

```
[1단계: 지역코드 매핑] ──▶ [2단계: 데이터 변환] ──▶ [3단계: 통합]
                                                        │
                                                        ▼
                                              [4단계: 테스트/검증]
                                                        │
                                                        ▼
                                              [5단계: 문서화/배포]
```

### 7.3 완료 조건 (Definition of Done)

| 항목 | 완료 기준 |
|------|----------|
| 코드 완성 | 모든 함수 구현 및 타입 힌트 적용 |
| 테스트 | 단위 테스트 커버리지 85% 이상 |
| 문서화 | 함수별 docstring 작성 완료 |
| 검증 | 기존/신규 형식 파일 모두 정상 동작 확인 |
| 코드 품질 | ruff 린터 경고 0개 |

---

## 8. 위험 요소 및 대응 방안

| 위험 요소 | 발생 가능성 | 영향도 | 대응 방안 |
|----------|:----------:|:------:|----------|
| 지역코드 매핑 불완전 | 중 | 중 | 매핑 실패 시 원본 코드 표시, 로그 기록 |
| 신규 API 형식 추가 변경 | 낮 | 높 | 형식 감지 로직 모듈화로 유연성 확보 |
| 기존 기능 영향 | 낮 | 높 | 기존 형식 우선 처리, 변환 로직 격리 |
| 대용량 파일 성능 저하 | 중 | 중 | 벡터화 연산 사용, 청크 처리 고려 |

---

## 9. 참고 자료

### 9.1 국토교통부 API 문서

- API명: 아파트 매매 실거래가 자료
- 서비스 URL: https://apis.data.go.kr/1613000/RTMSDataSvcAptTrade
- 서비스 시작일: 2024.07.17
- 데이터 갱신주기: 일 1회

### 9.2 지역코드 참조

- 행정표준코드관리시스템: https://www.code.go.kr
- 법정동코드 10자리 중 앞 5자리 사용

### 9.3 관련 파일

- 현재 애플리케이션: `D:\ai_program\실거래가분석대시보드\app.py`
- 기술문서: `D:\ai_program\실거래가분석대시보드\아파트 매매 실거래가 자료 기술문서.pdf`

---

## 변경 이력

| 버전 | 일자 | 작성자 | 변경 내용 |
|:----:|:----:|:------:|----------|
| 1.0 | 2026-02-03 | AI | 최초 작성 |

---

**문서 끝**
